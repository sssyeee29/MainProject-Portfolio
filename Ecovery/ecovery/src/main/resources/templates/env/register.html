<!--
í™˜ê²½í†¡í†¡ ê²Œì‹œê¸€ ë“±ë¡ í˜ì´ì§€
í™˜ê²½ ê´€ë ¨ ê²Œì‹œê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆëŠ” ì…ë ¥ í¼, ì—ë””í„°, ì´ë¯¸ì§€ ì—…ë¡œë“œ, ì´ëª¨ì§€, ë¯¸ë¦¬ë³´ê¸° ë“±ì˜ ê¸°ëŠ¥ ì œê³µ
ì‚¬ìš©ì ì •ë³´ ë° ì‘ì„± í†µê³„ëŠ” ì‚¬ì´ë“œë°”ì— í‘œì‹œë¨
@author : eunji
@fileName : register.html
@since : 250721
@history
    - 250721 | yukyeong | ë‹¨ìˆœ í…ŒìŠ¤íŠ¸ìš© ê¸€ì“°ê¸° í¼ ì„ì‹œ ì‘ì„±
    - 250730 | yukyeong | ì •ì‹ ê¸€ì“°ê¸° í˜ì´ì§€ ì „ë©´ ê°œí¸:
                          - ì œëª©, ë‚´ìš©, ì¹´í…Œê³ ë¦¬, íŒŒì¼ì²¨ë¶€ ë“± ì…ë ¥ UI êµ¬ì„±
                          - ë¯¸ë¦¬ë³´ê¸°/ì´ëª¨ì§€ ëª¨ë‹¬ ì¶”ê°€
                          - ì‚¬ì´ë“œë°”ì— ì‚¬ìš©ì í†µê³„ í‘œì‹œ
                          - env-register.jsì™€ ì—°ë™í•˜ì—¬ ìœ íš¨ì„± ê²€ì‚¬ ë° ë“±ë¡ ì²˜ë¦¬
                          - ìŠ¤í¬ë¦½íŠ¸ ì„¤ì •ê°’(maxFileSize, emoji, validationRules ë“±) íƒ€ì„ë¦¬í”„ë¡œ ì—°ë™
    - 250731 | yukyeong | Toast UI Editor ë³¸ë¬¸ ì…ë ¥ ì ìš©:
                          - ê¸°ì¡´ textarea â†’ toastui.Editorë¡œ êµì²´
                          - addImageBlobHookìœ¼ë¡œ ì´ë¯¸ì§€ ë³¸ë¬¸ ìë™ ì‚½ì… ì²˜ë¦¬
                          - ì‘ì„± ë‚´ìš©ì€ hiddenContentì— ì €ì¥ í›„ ì „ì†¡
                          - ê¸°ì¡´ íŒŒì¼ ì²¨ë¶€ ì˜ì—­ UIëŠ” ì£¼ì„ ì²˜ë¦¬ë¨
    - 250802 | yukyeong | í—¤ë”ì™€ í˜ì´ì§€ í—¤ë” ê°„ ê°„ê²© ì¶•ì†Œ, ë¶ˆí•„ìš”í•œ <main> íƒœê·¸ ì œê±°
    - 250802 | yukyeong | ë³¸ë¬¸ ê¸€ì ìˆ˜ ì œí•œ 2000ì â†’ 5000ìë¡œ í™•ì¥
    - 250811 | yukyeong | ë³¸ë¬¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ ê°œìˆ˜ ì œí•œ ê¸°ëŠ¥ ì¶”ê°€:
                          - MAX_CONTENT_IMAGES ìƒìˆ˜ ë„ì…(ê¸°ë³¸ 5ì¥)
                          - addImageBlobHookì—ì„œ í˜„ì¬ ë³¸ë¬¸ ì´ë¯¸ì§€ ê°œìˆ˜ í™•ì¸ í›„ ì´ˆê³¼ ì‹œ ì—…ë¡œë“œ ì°¨ë‹¨

-->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">

<head th:with="pageTitle='í™˜ê²½í†¡í†¡ - ìƒˆ ê¸€ ì“°ê¸°'">
    <title>í™˜ê²½í†¡í†¡</title>
    <th:block layout:fragment="css">
        <!-- Toast UI Editor ìŠ¤íƒ€ì¼ CDN ì¶”ê°€ -->
        <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
        <link rel="stylesheet" th:href="@{/css/write-post-style.css}">
    </th:block>
</head>

<body>
<!-- ë³¸ë¬¸ ì½˜í…ì¸  -->
<div layout:fragment="content" class="fade-in">

    <!-- í˜„ì¬ ìœ„ì¹˜ í‘œì‹œ (ë¹µë¶€ìŠ¤ëŸ¬ê¸°) -->
    <section class="breadcrumb">
        <div class="container">
            <nav class="breadcrumb-nav">
                <a th:href="@{/}">ğŸ </a>
                <span>></span>
                <a th:href="@{/eco-talk}">í™˜ê²½ í†¡í†¡</a>
                <span>></span>
                <span class="current">ìƒˆ ê¸€ ì“°ê¸°</span>
            </nav>
        </div>
    </section>

    <!-- Main Content -->
    <div class="container">
        <!-- Page Header -->
        <section class="page-header fade-in">
            <div class="page-header-content">
                <h1>âœï¸ ìƒˆ ê¸€ ì“°ê¸°</h1>
                <p>í™˜ê²½ì— ëŒ€í•œ ì†Œì¤‘í•œ ê²½í—˜ê³¼ ìƒê°ì„ ë‚˜ëˆ„ì–´ ì£¼ì„¸ìš”</p>
            </div>
        </section>

        <!-- Write Form Container -->
        <div class="write-container">
            <!-- Main Write Form -->
            <div class="write-main fade-in">
                <!-- ê¸€ ì‘ì„± í¼ - íƒ€ì„ë¦¬í”„ ê°ì²´ ë°”ì¸ë”© -->
                <form id="writeForm" class="write-form"
                      method="post" enctype="multipart/form-data">

                    <!-- Category Selection -->
                    <div class="form-section">
                        <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
                        <select id="categorySelect" name="categoryId" class="form-select" required>
                            <option value="">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                            <!-- JSë¡œ ë™ì  ë Œë”ë§ -->
                        </select>
                        <span class="error-message" id="categoryError"></span>
                    </div>

                    <!-- Title Input -->
                    <div class="form-section">
                        <label class="form-label" for="postTitle">ì œëª©</label>
                        <input type="text" id="postTitle" name="title" class="form-input title-input"
                               placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 255ì)" maxlength="255" required>
                        <div class="char-count"><span id="titleCount">0</span>/255</div>
                        <span class="error-message" id="titleError"></span>
                    </div>

                    <!-- Content Editor -->
                    <div class="form-section">
                        <label class="form-label" for="editor">ë‚´ìš©</label>
                        <!-- Toast UI Editorê°€ ë“¤ì–´ê°ˆ ì˜ì—­ (ê¸°ì¡´ í´ë˜ìŠ¤ ìœ ì§€) -->
                        <div id="editor" class="form-textarea content-editor"></div>
                        <!-- ì‹¤ì œ form ì „ì†¡ìš© hidden input -->
                        <input type="hidden" name="content" id="hiddenContent" />
                        <!-- ê¸€ì ìˆ˜ ì¹´ìš´íŠ¸ ìœ ì§€ -->
                        <div class="char-count"><span id="contentCount">0</span>/5000</div>
                        <span class="error-message" id="contentError"></span>
                    </div>

                    <!--                    &lt;!&ndash; File Upload &ndash;&gt;-->
                    <!--                    <div class="form-section">-->
                    <!--                        <label class="form-label">ì²¨ë¶€íŒŒì¼</label>-->
                    <!--                        <div class="upload-area" id="uploadArea">-->
                    <!--                            <div class="upload-content">-->
                    <!--                                <div class="upload-icon">ğŸ“</div>-->
                    <!--                                <div class="upload-text">-->
                    <!--                                    <strong>íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</strong>-->
                    <!--                                    <p>ì´ë¯¸ì§€ íŒŒì¼ (JPG, PNG, GIF) | ìµœëŒ€ 10MB</p>-->
                    <!--                                </div>-->
                    <!--                            </div>-->
                    <!--                            <input type="file" id="fileInput" name="envImgFiles" multiple accept="image/*" style="display: none;">-->
                    <!--                        </div>-->
                    <!--                        <div class="uploaded-files" id="uploadedFiles"></div>-->
                    <!--                        <span class="error-message" id="fileError"></span>-->
                    <!--                    </div>-->


                    <!-- Action Buttons -->
                    <div class="form-actions">
                        <button type="button" class="btn btn-outline" onclick="previewPost()">ğŸ“„ ë¯¸ë¦¬ë³´ê¸°</button>
                        <button type="button" class="btn btn-danger" onclick="location.href='/env/list'">âŒ ì·¨ì†Œ</button>
                        <button type="submit" class="btn btn-primary">ğŸ“ ë“±ë¡í•˜ê¸°</button>
                    </div>

                </form>

            </div>

        </div>
    </div>

    <!-- Preview Modal -->
    <div class="modal-overlay" id="previewModal" style="display: none;">
        <div class="modal-content preview-modal">
            <div class="modal-header">
                <h3>ğŸ“„ ë¯¸ë¦¬ë³´ê¸°</h3>
                <button class="modal-close" onclick="closePreview()">Ã—</button>
            </div>
            <div class="modal-body" id="previewContent">
                <!-- Preview content will be inserted here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePreview()">ë‹«ê¸°</button>
                <button class="btn btn-primary" onclick="submitPost()">ë“±ë¡í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ì´ëª¨ì§€ ì„ íƒ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="emojiModal" style="display: none;">
        <div class="modal-content emoji-modal">
            <div class="modal-header">
                <h3>ğŸ˜Š ì´ëª¨ì§€ ì„ íƒ</h3>
                <button class="modal-close" onclick="closeEmojiModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="emoji-categories">
                    <button class="emoji-category active" data-category="nature">ğŸŒ± ìì—°</button>
                    <button class="emoji-category" data-category="recycle">â™»ï¸ ì¬í™œìš©</button>
                    <button class="emoji-category" data-category="energy">âš¡ ì—ë„ˆì§€</button>
                    <button class="emoji-category" data-category="face">ğŸ˜Š í‘œì •</button>
                </div>
                <div class="emoji-grid" id="emojiGrid">
                    <!-- ì´ëª¨ì§€ ëª©ë¡ì´ JavaScriptë¡œ ë™ì  ìƒì„±ë¨ -->
                </div>
            </div>
        </div>
    </div>

</div>

<th:block layout:fragment="script">
    <script th:src="@{/js/write-post-script.js}"></script>
    <script th:src="@{/js/env-register.js}"></script>

    <!-- Toast UI Editor JS CDN ì¶”ê°€ -->
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>


    <!-- íƒ€ì„ë¦¬í”„ ë³€ìˆ˜ ë° ì—ë””í„° ì„¤ì • -->
    <script th:inline="javascript">

        const MAX_CONTENT_IMAGES = 5;

        var maxFileSize = /*[[${maxFileSize}]]*/ 10485760; // 10MB
        var maxFileCount = /*[[${maxFileCount}]]*/ 5;
        var fileUploadUrl = /*[[@{/api/env/upload-temp}]]*/ '/api/env/upload-temp';


        // ì—ë””í„° ì„¤ì •
        var editorConfig = {
            maxLength: 5000,
            allowedTags: ['b', 'i', 'u', 'ul', 'ol', 'li', 'a'],
            emojiCategories: {
                nature: ['ğŸŒ±', 'ğŸŒ³', 'ğŸŒ', 'ğŸŒ¿', 'ğŸŒ±', 'ğŸƒ', 'ğŸŒ¾', 'ğŸŒ¸'],
                recycle: ['â™»ï¸', 'ğŸ—‚ï¸', 'ğŸ“¦', 'ğŸ›’', 'ğŸ­', 'âš™ï¸'],
                energy: ['âš¡', 'ğŸ”‹', 'ğŸ’¡', 'â˜€ï¸', 'ğŸŒŠ', 'ğŸ’¨'],
                face: ['ğŸ˜Š', 'ğŸ˜', 'ğŸ¤”', 'ğŸ˜¢', 'ğŸ˜¡', 'ğŸ‘', 'ğŸ‘', 'â¤ï¸']
            }
        };

        // í¼ ê²€ì¦ ê·œì¹™
        var validationRules = {
            title: {
                required: true,
                maxLength: 255,
                message: 'ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (ìµœëŒ€ 255ì)'
            },
            content: {
                required: true,
                maxLength: 5000,
                message: 'ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (ìµœëŒ€ 5000ì)'
            },
            categoryId: {
                required: true,
                message: 'ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”'
            }
        };

        // Toast UI Editor ì´ˆê¸°í™”
        const editor = new toastui.Editor({
            el: document.querySelector('#editor'),
            height: '500px',
            initialEditType: 'wysiwyg',
            previewStyle: 'vertical',
            hooks: {
                // âœ… ì—…ë¡œë“œ 'ìˆœê°„'ì— ê°œìˆ˜ ì œí•œ
                addImageBlobHook: async (blob, callback) => {
                    try {
                        // í˜„ì¬ ë³¸ë¬¸ ë‚´ ì´ë¯¸ì§€ ê°œìˆ˜ ê³„ì‚°
                        const html = editor.getHTML();
                        const currentCount = (html.match(/<img\s/gi) || []).length;

                        if (currentCount >= MAX_CONTENT_IMAGES) {
                            alert(`ë³¸ë¬¸ ì´ë¯¸ì§€ëŠ” ìµœëŒ€ ${MAX_CONTENT_IMAGES}ì¥ê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
                            return; // ì—…ë¡œë“œ ì¤‘ë‹¨
                        }

                        const formData = new FormData();
                        formData.append('file', blob);

                        const res = await fetch('/api/env/upload-temp', {
                            method: 'POST',
                            body: formData
                        })

                        if (!res.ok) {
                            throw new Error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨');
                        }

                        const result = await res.json();
                        const imageUrl = `/ecovery/env/${result.fileName}`;
                        callback(imageUrl, 'ì—…ë¡œë“œ ì´ë¯¸ì§€');

                    } catch (err) {
                        console.error("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨", err);
                        alert("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    }
                }
            }
        });

        // form ì œì¶œ ì „ ì—ë””í„° ê°’ ì„¤ì •
        function beforeSubmit() {
            document.getElementById("hiddenContent").value = editor.getHTML();
            document.getElementById("writeForm").submit();
        }
    </script>
</th:block>
</body>
</html>