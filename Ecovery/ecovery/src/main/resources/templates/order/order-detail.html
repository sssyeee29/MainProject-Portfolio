<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>GreenCycle - 구매상세</title>
    <!-- CSS 파일 연결 -->
    <link rel="stylesheet" th:href="@{/css/order-detail.css}">
    <!-- 폰트 연결 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
<!-- ========================================
     헤더 영역 - 상단 고정 내비게이션
     ======================================== -->
<div th:replace="~{fragments/header :: header}"></div>

<!-- ========================================
     메인 콘텐츠 영역
     ======================================== -->
<main id="mainContent">
    <!-- ================================
         브레드크럼 네비게이션
         ================================ -->
    <section class="breadcrumb-section">
        <div class="container">
            <nav class="breadcrumb">
                <a th:href="@{/}">홈</a>
                <span class="breadcrumb-separator">></span>
                <a th:href="@{/mypage}">마이페이지</a>
                <span class="breadcrumb-separator">></span>
                <a th:href="@{/orders/history}">구매이력</a>
                <span class="breadcrumb-separator">></span>
                <span class="current-page">구매상세</span>
            </nav>
        </div>
    </section>

    <!-- ================================
         주문 상세 헤더 - 제목과 뒤로가기
         ================================ -->
    <section class="order-header">
        <div class="container">
            <div class="order-header-content">
                <!-- 제목 영역 -->
                <div class="order-title-section">
                    <h1>📋 구매상세</h1>
                    <p class="order-subtitle">주문하신 상품의 상세 정보를 확인하세요</p>
                </div>

            </div>
        </div>
    </section>

    <!-- ================================
         주문 상세 정보 섹션 - 새로운 레이아웃
         ================================ -->
    <section class="order-details">
        <div class="container">
            <!-- 새로운 그리드 컨테이너 - 세로형 레이아웃 -->
            <div class="order-layout-grid">

                <!-- =====================
                     1. 주문 기본 정보 카드 (전체 폭)
                     ===================== -->
                <div class="order-info-card full-width">
                    <div class="card-header">
                        <h2 class="card-title">📋 주문 정보</h2>
                        <!-- 주문 상태 배지 -->
                        <div class="order-status-badge" id="orderStatusBadge">
                            <span class="status-text">배송완료</span>
                        </div>
                    </div>
                    <!-- 주문 기본 정보 그리드 -->
                    <div class="order-basic-info">
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">주문번호</span>
                                <span class="info-value" id="orderNumber" th:text="${order.orderUuid}">ORD-2025010001</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">주문일자</span>
                                <span class="info-value" id="orderDate"
                                      th:text="${#dates.format(order.createdAt, 'yyyy년 M월 d일')}">2025년 1월 15일</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">주문자</span>
                                <span class="info-value" id="orderName" th:text="${order.name}">김환경</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">연락처</span>
                                <span class="info-value" id="orderPhone" th:text="${order.phoneNumber}">010-****-1234</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- =====================
                     2. 주문 상품 정보 카드 (전체 폭)
                     ===================== -->
                <div class="order-product-card full-width">
                    <div class="card-header">
                        <h2 class="card-title">📦 주문 상품</h2>
                        <!-- 상품 개수 표시 -->
                        <span class="product-count" id="productCount"
                              th:text="'총 ' + ${order.orderItems.size()} + '개 상품'">총 2개 상품</span>
                    </div>
                    <!-- 주문 상품 목록 -->
                    <div class="product-list" id="productList">
                        <!-- 주문 상품 목록 반복 렌더링 -->
                        <div th:each="item : ${order.orderItems}" class="product-item">
                            <!-- 상품 이미지 -->
                            <div class="product-image">
                                <img th:src="@{'/api/images/' + ${item.itemImgId}}"
                                     th:alt="${item.itemName}"
                                     onerror="this.src='data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'><rect fill=\'%23e3f2fd\' width=\'100\' height=\'100\'/><text x=\'50\' y=\'55\' font-size=\'40\' text-anchor=\'middle\'>📦</text></svg>'">
                            </div>
                            <!-- 상품 상세 정보 -->
                            <div class="product-details">
                                <h3 class="product-name" th:text="${item.itemName}">상품명</h3>
                                <p class="product-description" th:text="${item.itemName}">상품 설명</p>
                                <div class="product-options">
                                    <span class="option-item">기본 옵션</span>
                                </div>
                            </div>
                            <!-- 수량 정보 -->
                            <div class="product-quantity">
                                <span class="quantity-label">수량</span>
                                <span class="quantity-value" th:text="${item.count} + '개'">1개</span>
                            </div>
                            <!-- 가격 정보 -->
                            <div class="product-price">
                                    <span class="unit-price"
                                          th:text="${#numbers.formatInteger(item.orderPrice / item.count, 3)} + '원'">15,000원</span>
                                <span class="total-price"
                                      th:text="${#numbers.formatInteger(item.orderPrice, 3)} + '원'">15,000원</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- =====================
                     3. 배송정보와 결제정보 (1x2 그리드)
                     ===================== -->
                <div class="delivery-payment-section">

                    <!-- 배송 정보 카드 (왼쪽) -->
                    <div class="delivery-info-card">
                        <div class="card-header">
                            <h2 class="card-title">🚚 배송 정보</h2>
                            <!-- 배송 조회 버튼 -->
                            <button class="btn-track-delivery" onclick="trackDelivery()">
                                <span class="track-icon">🔍</span>
                                <span class="track-text">배송조회</span>
                            </button>
                        </div>
                        <div class="delivery-content">
                            <!-- 배송 상태 타임라인 -->
                            <div class="status-timeline">
                                <!-- JavaScript로 동적 생성됩니다 -->
                            </div>

                            <!-- 배송지 정보 -->
                            <div class="delivery-address">
                                <h3 class="address-title">배송지 정보</h3>
                                <div class="address-details">
                                    <div class="address-item">
                                        <span class="address-label">받는분</span>
                                        <span class="address-value" th:text="${order.name}">받는분 이름</span>
                                    </div>
                                    <div class="address-item">
                                        <span class="address-label">연락처</span>
                                        <span class="address-value" th:text="${order.phoneNumber}">연락처</span>
                                    </div>
                                    <div class="address-item">
                                        <span class="address-label">주소</span>
                                        <span class="address-value">
                                                <span th:text="${order.roadAddress}">주소</span><br>
                                                <span th:text="${order.detailAddress}" th:if="${order.detailAddress}">상세주소</span>
                                            </span>
                                    </div>
                                    <div class="address-item">
                                        <span class="address-label">배송요청사항</span>
                                        <span class="address-value">부재 시 경비실에 맡겨주세요</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 결제 정보 카드 (오른쪽) -->
                    <div class="payment-info-card">
                        <div class="card-header">
                            <h2 class="card-title">💳 결제 정보</h2>
                        </div>
                        <div class="payment-content">
                            <!-- 결제 요약 정보 -->
                            <div class="payment-summary">
                                <div class="summary-row">
                                    <span class="summary-label">상품금액</span>
                                    <span class="summary-value"
                                          th:text="${#numbers.formatInteger(order.payAmount, 3)} + '원'">상품금액</span>
                                </div>
                                <div class="summary-row">
                                    <span class="summary-label">배송비</span>
                                    <span class="summary-value">0원</span>
                                </div>
                                <div class="summary-row discount">
                                    <span class="summary-label">할인금액</span>
                                    <span class="summary-value">0원</span>
                                </div>
                                <div class="summary-row total">
                                    <span class="summary-label">최종결제금액</span>
                                    <span class="summary-value"
                                          th:text="${#numbers.formatInteger(order.payAmount, 3)} + '원'">최종결제금액</span>
                                </div>
                            </div>

                            <!-- 결제 방법 정보 -->
                            <div class="payment-method">
                                <h3 class="method-title">결제 방법</h3>
                                <div class="method-details">
                                    <div class="method-item">
                                        <span class="method-icon">💳</span>
                                        <div class="method-info">
                                            <span class="method-name" th:text="${order.payMethod}">결제방법</span>
                                            <span class="method-detail">결제카드 정보</span>
                                            <span class="method-date"
                                                  th:text="'결제일시: ' + ${#temporals.format(order.paidAt, 'yyyy.MM.dd HH:mm')}">결제일시</span>
                                        </div>
                                        <span class="method-amount"
                                              th:text="${#numbers.formatInteger(order.payAmount, 3)} + '원'">결제금액</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- =====================
                     4. 주문 관리 버튼들 (전체 폭)
                     ===================== -->
                <div class="order-actions-card full-width">
                    <div class="card-header">
                        <h2 class="card-title">⚙️ 주문 관리</h2>
                    </div>

                    <!-- 액션 버튼들 - 요청사항에 따라 4개만 -->
                    <div class="action-buttons">
                        <!-- 상품후기 작성 버튼 -->
                        <button class="btn-action btn-review" onclick="writeReview()">
                            <span class="btn-icon">⭐</span>
                            <span class="btn-text">상품후기 작성</span>
                        </button>

                        <!-- 교환/반품 버튼 -->
                        <button class="btn-action btn-exchange" onclick="requestExchange()">
                            <span class="btn-icon">🔄</span>
                            <span class="btn-text">교환/반품</span>
                        </button>

                        <!-- 주문문의 버튼 -->
                        <a th:href="@{/support/orders/{id}(id=${order.orderId})}" class="btn-action btn-inquiry">
                            <span class="btn-icon">❓</span>
                            <span class="btn-text">Q & A</span>
                        </a>

                        <!-- 영수증 다운로드 버튼 -->
                        <button class="btn-action btn-receipt" onclick="downloadReceipt()">
                            <span class="btn-icon">📄</span>
                            <span class="btn-text">영수증 다운로드</span>
                        </button>
                    </div>

                    <!-- 주의사항 안내 -->
                    <div class="order-notes">
                        <h3 class="notes-title">📌 주문 관련 안내</h3>
                        <ul class="notes-list">
                            <li>배송완료 후 7일 이내에 교환/반품 신청이 가능합니다.</li>
                            <li>상품후기 작성 시 추가 포인트를 적립해드립니다.</li>
                            <li>친환경 포장재 사용으로 지구를 보호합니다. 🌍</li>
                            <li>문의사항은 고객센터(1588-1234) 또는 온라인으로 접수 가능합니다.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<!-- ========================================
     모달 영역들
     ======================================== -->

<!-- 교환/반품 모달 -->
<div class="modal-overlay" id="exchangeModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>🔄 교환/반품 신청</h3>
            <button class="modal-close" onclick="closeExchangeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="exchangeForm">
                <div class="form-group">
                    <label>신청 유형</label>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="exchangeType" value="exchange">
                            <span>교환</span>
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="exchangeType" value="return">
                            <span>반품</span>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>사유</label>
                    <select name="reason" required>
                        <option value="">사유를 선택해주세요</option>
                        <option value="defective">상품 불량</option>
                        <option value="different">주문과 다른 상품</option>
                        <option value="damaged">배송 중 파손</option>
                        <option value="size_issue">사이즈 문제</option>
                        <option value="other">기타</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>상세 내용</label>
                    <textarea name="description" placeholder="자세한 사유를 입력해주세요" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label>첨부 사진 (선택)</label>
                    <input type="file" name="attachments" multiple accept="image/*">
                    <small>상품 상태를 확인할 수 있는 사진을 첨부해주세요</small>
                </div>
            </form>
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeExchangeModal()">취소</button>
            <button class="btn btn-primary" onclick="submitExchangeRequest()">신청하기</button>
        </div>
    </div>
</div>

<!-- ========================================
     푸터 영역
     ======================================== -->
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- ========================================
     JavaScript 파일 연결
     ======================================== -->
<script th:src="@{/js/order-detail.js}"></script>

<!-- ========================================
     Thymeleaf 데이터를 JavaScript로 전달
     ======================================== -->
<script th:inline="javascript">
    // 서버에서 전달받은 주문 상세 데이터
    var orderData = /*[[${order}]]*/ null;
    var user = /*[[${session.user}]]*/ null;
    var csrfHeader = /*[[${_csrf.headerName}]]*/ '';

    // API URL 설정
    var orderCancelUrl = /*[[@{/api/orders/{id}/cancel}]]*/ '/api/orders/{id}/cancel';
    var exchangeRequestUrl = /*[[@{/api/orders/{id}/exchange}]]*/ '/api/orders/{id}/exchange';
    var reviewWriteUrl = /*[[@{/orders/{id}/review}]]*/ '/orders/{id}/review';
    var reorderUrl = /*[[@{/api/orders/{id}/reorder}]]*/ '/api/orders/{id}/reorder';
    var receiptDownloadUrl = /*[[@{/api/orders/{id}/receipt}]]*/ '/api/orders/{id}/receipt';
    var trackingUrl = /*[[@{/api/delivery/tracking/}]]*/ '/api/delivery/tracking/';

    // 주문 ID 설정 (order-detail.js에서 사용)
    var currentOrderId = orderData ? orderData.orderUuid : null;

    // 메시지 설정
    var messages = {
        cancelSuccess: '주문이 성공적으로 취소되었습니다.',
        cancelError: '주문 취소 중 오류가 발생했습니다.',
        exchangeSuccess: '교환/반품 신청이 완료되었습니다.',
        exchangeError: '교환/반품 신청 중 오류가 발생했습니다.',
        reorderSuccess: '장바구니에 상품이 추가되었습니다.',
        reorderError: '재주문 중 오류가 발생했습니다.'
    };

    // 페이지 로드 후 주문 데이터로 화면 업데이트
    document.addEventListener('DOMContentLoaded', function() {
        if (orderData) {
            // order-detail.js의 displayOrderData 함수 호출
            displayOrderData(orderData);
        }
    });

    // 모달 관련 함수들 (기존 코드와 호환성을 위해 추가)
    function closeExchangeModal() {
        document.getElementById('exchangeModal').style.display = 'none';
    }

    function submitExchangeRequest() {
        // 실제 교환/반품 신청 로직
        closeExchangeModal();
        showNotification('교환/반품 신청이 완료되었습니다.', 'success');
    }

    function requestExchange() {
        document.getElementById('exchangeModal').style.display = 'flex';
    }
</script>
</body>
</html>